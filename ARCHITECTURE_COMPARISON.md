# Single Thread vs Multi-Thread æ¶æ§‹å°æ¯”

## âœ… åŠŸèƒ½å®Œå…¨ä¸€æ¨£ï¼

**æ‰€æœ‰åŠŸèƒ½éƒ½ä¿æŒä¸è®Š**ï¼š
- âœ… Login ç•«é¢
- âœ… æ”»æ“Šå‹•ç•«
- âœ… Critical Hit å‹•ç•«
- âœ… Lucky Kill å‹•ç•«
- âœ… Victory ç•«é¢
- âœ… æ‰€æœ‰ UI å…ƒç´ 

**å”¯ä¸€æ”¹è®Šçš„æ˜¯ï¼šæ¶æ§‹ï¼ˆå…§éƒ¨å¯¦ç¾æ–¹å¼ï¼‰**

---

## ğŸ“Š å…©ç¨®æ¶æ§‹å°æ¯”

### ğŸ”µ Single Threadï¼ˆå–®ç·šç¨‹ï¼‰æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ä¸»ç·šç¨‹ï¼ˆMain Threadï¼‰         â”‚
â”‚                                      â”‚
â”‚  1. åˆå§‹åŒ– ncurses                   â”‚
â”‚  2. é¡¯ç¤º login ç•«é¢                  â”‚
â”‚  3. å»ºç«‹ TLS é€£ç·š                    â”‚
â”‚  4. ui_game_loop() é–‹å§‹             â”‚
â”‚     â”‚                                â”‚
â”‚     â”œâ”€ ç”¨æˆ¶æŒ‰ç©ºæ ¼                    â”‚
â”‚     â”‚  â†“                             â”‚
â”‚     â”œâ”€ attack_cb_impl()             â”‚
â”‚     â”‚  â†“                             â”‚
â”‚     â”œâ”€ net_attack_and_get_state()   â”‚ â† é€™è£¡æœƒé˜»å¡ï¼
â”‚     â”‚  â†“ SSL_write/SSL_read         â”‚   ç­‰å¾…æœå‹™å™¨éŸ¿æ‡‰
â”‚     â”‚  â†“ (å¯èƒ½ç­‰ 100-500ms)          â”‚
â”‚     â”œâ”€ æ›´æ–° UI                       â”‚
â”‚     â”‚                                â”‚
â”‚     â”œâ”€ å®šæœŸ heartbeat_cb_impl()     â”‚
â”‚     â”‚  â†“                             â”‚
â”‚     â”œâ”€ net_heartbeat_get_state()    â”‚ â† é€™è£¡ä¹Ÿæœƒé˜»å¡ï¼
â”‚     â”‚  â†“ SSL_write/SSL_read         â”‚
â”‚     â””â”€ æ›´æ–° UI                       â”‚
â”‚                                      â”‚
â”‚  å•é¡Œï¼šç¶²çµ¡æ“ä½œæœƒé˜»å¡ UIï¼            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‹ä½œæµç¨‹**ï¼š
1. æ‰€æœ‰æ“ä½œéƒ½åœ¨**åŒä¸€å€‹ç·šç¨‹**ä¸­
2. ç•¶ `SSL_read()` ç­‰å¾…æœå‹™å™¨éŸ¿æ‡‰æ™‚ï¼Œ**æ•´å€‹ç¨‹åºéƒ½åœä¸‹ä¾†**
3. UI æ›´æ–°æœƒè¢«å»¶é²ï¼ˆé›–ç„¶æœ‰ `timeout(100)`ï¼Œä½†é‚„æ˜¯æœƒå¡ï¼‰

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š`client.c` ç¬¬ 608-710 è¡Œ

---

### ğŸŸ¢ Multi-Threadï¼ˆå¤šç·šç¨‹ï¼‰æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»ç·šç¨‹ï¼ˆUI Threadï¼‰  â”‚      â”‚  Network Thread      â”‚
â”‚                      â”‚      â”‚                      â”‚
â”‚  1. åˆå§‹åŒ– ncurses   â”‚      â”‚                      â”‚
â”‚  2. é¡¯ç¤º login ç•«é¢  â”‚      â”‚                      â”‚
â”‚  3. å»ºç«‹ TLS é€£ç·š    â”‚      â”‚                      â”‚
â”‚  4. å•Ÿå‹• Network     â”‚â”€â”€â”€â”€â”€â†’â”‚  é–‹å§‹é‹è¡Œ            â”‚
â”‚     Thread           â”‚      â”‚                      â”‚
â”‚                      â”‚      â”‚  æŒçºŒå¾ªç’°ï¼š          â”‚
â”‚  5. ui_game_loop()   â”‚      â”‚  â”œâ”€ æª¢æŸ¥æ”»æ“Šè«‹æ±‚     â”‚
â”‚     â”‚                â”‚      â”‚  â”œâ”€ è™•ç†æ”»æ“Š         â”‚
â”‚     â”œâ”€ ç”¨æˆ¶æŒ‰ç©ºæ ¼    â”‚      â”‚  â”œâ”€ ç™¼é€ heartbeat   â”‚
â”‚     â”‚  â†“             â”‚      â”‚  â””â”€ æ›´æ–°å…±äº«ç‹€æ…‹     â”‚
â”‚     â”œâ”€ attack_cb()   â”‚      â”‚                      â”‚
â”‚     â”‚  â†“             â”‚      â”‚                      â”‚
â”‚     â”œâ”€ è¨­ç½®æ¨™èªŒ      â”‚â”€â”€â”€â”€â”€â†’â”‚  æ”¶åˆ°æ”»æ“Šè«‹æ±‚        â”‚
â”‚     â”‚  attack_requestâ”‚      â”‚  â†“                   â”‚
â”‚     â”‚  = true        â”‚      â”‚  è™•ç†æ”»æ“Š            â”‚
â”‚     â”‚  â†“             â”‚      â”‚  â†“                   â”‚
â”‚     â”œâ”€ ç­‰å¾…å®Œæˆ      â”‚      â”‚  æ›´æ–° shared.latest_ â”‚
â”‚     â”‚  (ä¸é˜»å¡ UI!)  â”‚      â”‚  state               â”‚
â”‚     â”‚  â†“             â”‚â†â”€â”€â”€â”€â”€â”‚  ç™¼é€ä¿¡è™Ÿé€šçŸ¥ UI     â”‚
â”‚     â”œâ”€ è®€å–çµæœ      â”‚      â”‚                      â”‚
â”‚     â””â”€ æ›´æ–° UI       â”‚      â”‚                      â”‚
â”‚                      â”‚      â”‚  æ¯ 0.5 ç§’è‡ªå‹•ç™¼é€   â”‚
â”‚     heartbeat_cb()   â”‚â†â”€â”€â”€â”€â”€â”‚  heartbeat           â”‚
â”‚     â†“                â”‚      â”‚  â†“                   â”‚
â”‚     è®€å–å…±äº«ç‹€æ…‹     â”‚      â”‚  æ›´æ–° shared.latest_ â”‚
â”‚     (ä¸é˜»å¡!)        â”‚      â”‚  state               â”‚
â”‚                      â”‚      â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ SharedGameStateâ”‚
            â”‚ (mutex ä¿è­·)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‹ä½œæµç¨‹**ï¼š
1. **å…©å€‹ç·šç¨‹åŒæ™‚é‹è¡Œ**ï¼š
   - UI Threadï¼šè™•ç†æ‰€æœ‰ç•«é¢ã€ç”¨æˆ¶è¼¸å…¥
   - Network Threadï¼šè™•ç†æ‰€æœ‰ç¶²çµ¡æ“ä½œ
2. é€šé**å…±äº«è³‡æ–™çµæ§‹**ï¼ˆ`SharedGameState`ï¼‰é€šä¿¡
3. ä½¿ç”¨ **mutex** ä¿è­·å…±äº«è³‡æ–™
4. ä½¿ç”¨ **condition variable** é€šçŸ¥å°æ–¹

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š
- å…±äº«è³‡æ–™çµæ§‹ï¼š`client.c` ç¬¬ 40-51 è¡Œ
- Network Threadï¼š`client.c` ç¬¬ 311-417 è¡Œ
- Multi-threaded æ¨¡å¼ï¼š`client.c` ç¬¬ 408-601 è¡Œ

---

## ğŸ” è©³ç´°é‹ä½œæµç¨‹å°æ¯”

### æ”»æ“Šæµç¨‹å°æ¯”

#### Single Threadï¼š
```
æ™‚é–“è»¸ï¼š
0ms   ç”¨æˆ¶æŒ‰ç©ºæ ¼
10ms  attack_cb_impl() é–‹å§‹
20ms  net_attack_and_get_state() é–‹å§‹
30ms  SSL_write() ç™¼é€å°åŒ…
      â†“
      ã€ç­‰å¾…æœå‹™å™¨éŸ¿æ‡‰...ã€‘
      â†“
200ms SSL_read() æ”¶åˆ°éŸ¿æ‡‰
210ms æ›´æ–° UI
220ms é¡¯ç¤ºçµæœ
```

**å•é¡Œ**ï¼šåœ¨ 30ms-200ms ä¹‹é–“ï¼Œ**æ•´å€‹ç¨‹åºéƒ½å¡ä½**ï¼ŒUI ç„¡æ³•æ›´æ–°ï¼

#### Multi-Threadï¼š
```
æ™‚é–“è»¸ï¼š

UI Thread              Network Thread
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0ms   ç”¨æˆ¶æŒ‰ç©ºæ ¼
10ms  attack_cb_impl()
      â†“
      attack_requested = true
      signal(attack_request_cond)
      â†“
      ã€ç­‰å¾… Network Thread...ã€‘
      â†“                    â”‚
                          â”‚ æ”¶åˆ°ä¿¡è™Ÿ
                          â”‚ â†“
                          â”‚ è™•ç†æ”»æ“Š
                          â”‚ SSL_write()
                          â”‚ â†“
                          â”‚ ã€ç­‰å¾…æœå‹™å™¨...ã€‘
                          â”‚ â†“
200ms                    â”‚ SSL_read() æ”¶åˆ°
                        â”‚ â†“
                        â”‚ æ›´æ–° shared.latest_state
                        â”‚ attack_completed = true
                        â”‚ signal(state_updated_cond)
      â†“                    â”‚
      ã€æ”¶åˆ°ä¿¡è™Ÿã€‘          â”‚
      â†“                    â”‚
210ms è®€å– latest_state
220ms æ›´æ–° UI
230ms é¡¯ç¤ºçµæœ
```

**å„ªå‹¢**ï¼šåœ¨ç­‰å¾…æœå‹™å™¨éŸ¿æ‡‰æ™‚ï¼Œ**UI Thread ä»ç„¶å¯ä»¥è™•ç†å…¶ä»–äº‹æƒ…**ï¼ˆé›–ç„¶é€™è£¡æ˜¯ç­‰å¾…ï¼Œä½†è‡³å°‘ä¸æœƒé˜»å¡æ•´å€‹ç¨‹åºï¼‰

---

### Heartbeat æµç¨‹å°æ¯”

#### Single Threadï¼š
```
æ™‚é–“è»¸ï¼š
0ms   ui_game_loop() æª¢æŸ¥ idle_ticks
      â†“
500ms idle_ticks > 5ï¼Œè§¸ç™¼ heartbeat
510ms heartbeat_cb_impl() é–‹å§‹
520ms net_heartbeat_get_state() é–‹å§‹
530ms SSL_write() ç™¼é€ heartbeat
      â†“
      ã€ç­‰å¾…æœå‹™å™¨éŸ¿æ‡‰...ã€‘
      â†“
600ms SSL_read() æ”¶åˆ°éŸ¿æ‡‰
610ms æ›´æ–° UI
```

**å•é¡Œ**ï¼šæ¯æ¬¡ heartbeat éƒ½æœƒé˜»å¡ UIï¼

#### Multi-Threadï¼š
```
æ™‚é–“è»¸ï¼š

UI Thread              Network Thread
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0ms                    â”‚ æŒçºŒå¾ªç’°
                      â”‚ â†“
                      â”‚ æ¯ 0.5 ç§’è‡ªå‹•ç™¼é€
                      â”‚ heartbeat
                      â”‚ â†“
                      â”‚ SSL_write()
                      â”‚ â†“
                      â”‚ ã€ç­‰å¾…æœå‹™å™¨...ã€‘
                      â”‚ â†“
500ms                 â”‚ SSL_read() æ”¶åˆ°
                      â”‚ â†“
                      â”‚ æ›´æ–° shared.latest_state
                      â”‚ signal(state_updated_cond)
      â†“                    â”‚
      heartbeat_cb_impl()  â”‚
      â†“                    â”‚
      ã€è®€å– latest_stateã€‘â”‚
      â†“                    â”‚
510ms æ›´æ–° UI
```

**å„ªå‹¢**ï¼š
- Network Thread **è‡ªå‹•æŒçºŒç™¼é€** heartbeatï¼Œä¸éœ€è¦ UI è§¸ç™¼
- UI Thread **åªæ˜¯è®€å–**å…±äº«ç‹€æ…‹ï¼Œä¸æœƒé˜»å¡
- **æ›´æµæš¢**çš„ UI æ›´æ–°

---

## ğŸ› ï¸ æˆ‘åšäº†ä»€éº¼ï¼Ÿ

### 1. å‰µå»ºå…±äº«è³‡æ–™çµæ§‹ï¼ˆ`SharedGameState`ï¼‰

```c
typedef struct {
    pthread_mutex_t lock;              // ä¿è­·å…±äº«è³‡æ–™
    pthread_cond_t state_updated_cond;  // é€šçŸ¥ UI æœ‰æ–°ç‹€æ…‹
    pthread_cond_t attack_request_cond; // é€šçŸ¥ Network æœ‰æ”»æ“Šè«‹æ±‚
    
    UiGameState latest_state;          // æœ€æ–°çš„éŠæˆ²ç‹€æ…‹
    bool state_updated;                // æ˜¯å¦æœ‰æ–°ç‹€æ…‹
    bool attack_requested;             // UI æ˜¯å¦è«‹æ±‚æ”»æ“Š
    bool attack_completed;             // æ”»æ“Šæ˜¯å¦å®Œæˆ
    bool should_exit;                  // æ˜¯å¦æ‡‰è©²é€€å‡º
    int network_error;                 // Network Thread çš„éŒ¯èª¤ç¢¼
} SharedGameState;
```

**ä½œç”¨**ï¼šè®“å…©å€‹ç·šç¨‹å¯ä»¥å®‰å…¨åœ°å…±äº«è³‡æ–™

---

### 2. å‰µå»º Network Thread å‡½æ•¸

```c
static void *network_thread_func(void *arg) {
    // æŒçºŒå¾ªç’°ï¼š
    while (!should_exit) {
        if (æœ‰æ”»æ“Šè«‹æ±‚) {
            // è™•ç†æ”»æ“Š
            net_attack_and_get_state();
            // æ›´æ–°å…±äº«ç‹€æ…‹
            // é€šçŸ¥ UI Thread
        } else {
            // ç™¼é€ heartbeat
            net_heartbeat_get_state();
            // æ›´æ–°å…±äº«ç‹€æ…‹
            // é€šçŸ¥ UI Thread
        }
    }
}
```

**ä½œç”¨**ï¼šæ‰€æœ‰ç¶²çµ¡æ“ä½œéƒ½åœ¨é€™å€‹ç·šç¨‹ä¸­ï¼Œ**ä¸æœƒé˜»å¡ UI**

---

### 3. ä¿®æ”¹ attack_cb å’Œ heartbeat_cb

#### Single Thread ç‰ˆæœ¬ï¼š
```c
int attack_cb_impl(UiGameState *out_state) {
    // ç›´æ¥èª¿ç”¨ç¶²çµ¡å‡½æ•¸ï¼ˆæœƒé˜»å¡ï¼‰
    net_attack_and_get_state(ssl, &s);
    // è½‰æ›è³‡æ–™
    *out_state = ...;
    return 0;
}
```

#### Multi-Thread ç‰ˆæœ¬ï¼š
```c
int attack_cb_impl(UiGameState *out_state) {
    // 1. è¨­ç½®æ”»æ“Šè«‹æ±‚æ¨™èªŒ
    shared->attack_requested = true;
    signal(attack_request_cond);  // é€šçŸ¥ Network Thread
    
    // 2. ç­‰å¾… Network Thread å®Œæˆ
    wait(state_updated_cond);
    
    // 3. è®€å–çµæœï¼ˆä¸é˜»å¡ç¶²çµ¡æ“ä½œï¼‰
    *out_state = shared->latest_state;
    return 0;
}
```

**æ”¹è®Š**ï¼šå¾ã€Œç›´æ¥èª¿ç”¨ç¶²çµ¡å‡½æ•¸ã€è®Šæˆã€Œé€šéå…±äº«è³‡æ–™çµæ§‹é€šä¿¡ã€

---

### 4. å‰µå»ºæ–°çš„å•Ÿå‹•å‡½æ•¸

```c
static int run_interactive_mode_threaded(void) {
    // 1. åˆå§‹åŒ–å…±äº«è³‡æ–™çµæ§‹
    pthread_mutex_init(&shared.lock, NULL);
    pthread_cond_init(&shared.state_updated_cond, NULL);
    
    // 2. å»ºç«‹é€£ç·šï¼ˆä¸»ç·šç¨‹ï¼‰
    // ...
    
    // 3. å•Ÿå‹• Network Thread
    pthread_create(&network_thread, NULL, network_thread_func, &net_args);
    
    // 4. åœ¨ä¸»ç·šç¨‹é‹è¡Œ UI
    ui_game_loop(username, attack_cb_impl, heartbeat_cb_impl);
    
    // 5. æ¸…ç†
    pthread_join(network_thread, NULL);
}
```

**ä½œç”¨**ï¼šå•Ÿå‹•å…©å€‹ç·šç¨‹ï¼Œè®“å®ƒå€‘å”åŒå·¥ä½œ

---

## ğŸ“ˆ å„ªå‹¢å°æ¯”

| ç‰¹æ€§ | Single Thread | Multi-Thread |
|------|--------------|-------------|
| **UI éŸ¿æ‡‰æ€§** | âš ï¸ ç¶²çµ¡æ“ä½œæœƒé˜»å¡ UI | âœ… UI æ°¸é æµæš¢ |
| **æ¶æ§‹è¤‡é›œåº¦** | âœ… ç°¡å–® | âš ï¸ è¼ƒè¤‡é›œï¼ˆéœ€è¦ mutexï¼‰ |
| **èª¿è©¦é›£åº¦** | âœ… å®¹æ˜“ | âš ï¸ è¼ƒé›£ï¼ˆrace conditionï¼‰ |
| **æ€§èƒ½** | âœ… è¶³å¤ ï¼ˆéŠæˆ²å ´æ™¯ï¼‰ | âœ… æ›´å¥½ |
| **å¯æ“´å±•æ€§** | âŒ å—é™ | âœ… å®¹æ˜“æ“´å±• |

---

## ğŸ¯ ç¸½çµ

### åŠŸèƒ½ï¼š**å®Œå…¨ä¸€æ¨£**
- æ‰€æœ‰ç•«é¢ã€å‹•ç•«ã€åŠŸèƒ½éƒ½ä¿æŒä¸è®Š
- ç”¨æˆ¶é«”é©—å®Œå…¨ä¸€æ¨£

### æ¶æ§‹ï¼š**å®Œå…¨ä¸åŒ**
- **Single Thread**ï¼šæ‰€æœ‰æ“ä½œåœ¨åŒä¸€å€‹ç·šç¨‹ï¼Œæœƒäº’ç›¸é˜»å¡
- **Multi-Thread**ï¼šUI å’Œ Network åˆ†é›¢ï¼Œä¸æœƒäº’ç›¸é˜»å¡

### å¯¦ç¾æ–¹å¼ï¼š
1. å‰µå»ºå…±äº«è³‡æ–™çµæ§‹ï¼ˆmutex ä¿è­·ï¼‰
2. å‰µå»º Network Threadï¼ˆè™•ç†æ‰€æœ‰ç¶²çµ¡æ“ä½œï¼‰
3. ä¿®æ”¹ callbackï¼ˆé€šéå…±äº«è³‡æ–™çµæ§‹é€šä¿¡ï¼‰
4. å•Ÿå‹•å…©å€‹ç·šç¨‹å”åŒå·¥ä½œ

### çµæœï¼š
- **UI æ›´æµæš¢**ï¼ˆç¶²çµ¡æ“ä½œä¸é˜»å¡ UIï¼‰
- **æ¶æ§‹æ›´æ¸…æ™°**ï¼ˆè·è²¬åˆ†é›¢ï¼‰
- **åŠŸèƒ½å®Œå…¨ä¿æŒä¸è®Š**
